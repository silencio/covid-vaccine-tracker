name: Scrape latest data

on:
  push:
  workflow_dispatch:
  schedule:
    - cron:  '6,26,46 * * * *'

jobs:
  scheduled:
    runs-on: ubuntu-latest
    steps:
    - name: Check out this repo
      uses: actions/checkout@v2
    - name: Fetch latest data
      run: |-
        curl https://partners.doctolib.fr/booking/la-salle-des-greniers-saint-jean-centre-de-vaccination.json | jq . > angers.la-salle-des-greniers-saint-jean-centre-de-vaccination.json
        #curl https://partners.doctolib.fr/booking/centre-de-vaccination-covid-de-versailles.json | jq . > centre-de-vaccination-covid-de-versailles.json
        #curl https://partners.doctolib.fr/booking/centre-de-vaccination-covid-19-du-var.json | jq . > centre-de-vaccination-covid-19-du-var.json
        start_date=$(date +%Y-%m-%d -d "+7 days")
        curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2547915&agenda_ids=419043&insurance_sector=public&practice_ids=164517&destroy_temporary=true&limit=15&allowNewPatients=true&telehealth=false&profileId=242564&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=4435" | jq . > angers.la-salle-des-greniers-saint-jean-centre-de-vaccination.availabilities.2547915.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2551694&agenda_ids=411755-411756&insurance_sector=public&practice_ids=165067&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=243226&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=19624" | jq . > hyeres.centre-de-vaccination-covid-19-du-var.availabilities.2551694.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2551694&agenda_ids=415704&insurance_sector=public&practice_ids=166708&destroy_temporary=true&limit=4&allowNewPatients=true&telehealth=false&profileId=243226&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=20511" | jq . > la-garde.centre-de-vaccination-covid-19-du-var.2551694.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2532017&agenda_ids=412038&insurance_sector=public&practice_ids=165155&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=243206&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=917" | jq . > centre-de-vaccination-covid-19-de-rambouillet.availabilities.2532017.json
        curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2532017&agenda_ids=412033-413610-413611-412034&insurance_sector=public&practice_ids=165154&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=243464&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=3343" | jq . > centre-de-vaccination-covid-19-de-montigny-le-bretonneux.availabilities.2532017.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2532017&agenda_ids=422186&insurance_sector=public&practice_ids=164634&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=242655&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=2546" | jq . > versailles.centre-de-vaccination-covid-de-versailles.2532017.json
        # <PARIS>
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2554449&agenda_ids=412688-412687&insurance_sector=public&practice_ids=165403&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=243484&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=2063" | jq . > paris12.centre-de-vaccination-covid-centre-de-sante-bauchat-nation.2554449.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2549915&agenda_ids=415625&insurance_sector=public&practice_ids=164922&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=242842&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=10062" | jq . > paris11.centre-de-vaccination-covid-19-ville-de-paris.2549915.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2549915&agenda_ids=418656&insurance_sector=public&practice_ids=164925&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=242842&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=10062" | jq . > paris13-bertheau.centre-de-vaccination-covid-19-ville-de-paris.2549915.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2549915&agenda_ids=415630&insurance_sector=public&practice_ids=164812&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=242842&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=10062" | jq . > paris03.centre-de-vaccination-covid-19-ville-de-paris.2549915.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2549915&agenda_ids=415620&insurance_sector=public&practice_ids=164924&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=242842&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=10062" | jq . > paris13-mairie.centre-de-vaccination-covid-19-ville-de-paris.2549915.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2549915&agenda_ids=415617&insurance_sector=public&practice_ids=164926&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=242842&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=10062" | jq . > paris19-le104.centre-de-vaccination-covid-19-ville-de-paris.2549915.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2549915&agenda_ids=415613&insurance_sector=public&practice_ids=166459&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=242842&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=10062" | jq . > paris20.centre-de-vaccination-covid-19-ville-de-paris.2549915.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2540289&agenda_ids=408405-408407&insurance_sector=public&practice_ids=163600&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=241561&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=856" | jq . > paris19-rotschild.centre-de-vaccination-paris-19eme.2540289.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2548992&agenda_ids=425392-425408&insurance_sector=public&practice_ids=164740&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=216728&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=1030" | jq . > paris18.ars-idf-centre-covisan-cpts-paris-18.2548992.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2554319&agenda_ids=415462-423723-412564-412566&insurance_sector=public&practice_ids=165129&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=142559&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=2229" | jq . > paris17.sos-medecins-paris.2554319.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2552122&agenda_ids=417116-427281&insurance_sector=public&practice_ids=165139&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=243251&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=1761" | jq . > paris16.centre-de-vaccination-covid-centre-henry-dunant-croix-rouge-francaise.2552122.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2549775&agenda_ids=423750-411935-411154-411937&insurance_sector=public&practice_ids=164810&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=242819&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=2473" | jq . > paris15-pasteur.centre-medical-institut-pasteur-cmip-vaccination-covid-19.2549775.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2553445&agenda_ids=412405&insurance_sector=public&practice_ids=165280&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=243351&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=2316" | jq . > paris15-mairie.centre-de-vaccination-covid-paris-15e.2553445.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2548939&agenda_ids=410948&insurance_sector=public&practice_ids=164733&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=242723&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=1913" | jq . > paris14-mairie.centre-de-vaccination-paris-14e.2548939.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2608840&agenda_ids=411699&insurance_sector=public&practice_ids=165042&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=243065&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=28&vaccinationCenter=true&nbConfirmedVaccinationAppointments=1044" | jq . > paris10-moderna.centre-de-vaccination-covid-19-centre-medical-international-cmi.2608840.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2551827&agenda_ids=411898&insurance_sector=public&practice_ids=165089&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=243123&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=1205" | jq . > paris08.centre-de-vaccination-covid-19-paris-8e.2551827.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2551398&agenda_ids=411636-411957&insurance_sector=public&practice_ids=165020&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=243130&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=2055" | jq . > paris07.centre-de-vaccination-mairie-du-7eme-paris.2551398.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2614519&agenda_ids=411636-411957&insurance_sector=public&practice_ids=165020&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=243130&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=2055" | jq . > paris07-moderna.centre-de-vaccination-mairie-du-7eme-paris.2614519.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2594946&agenda_ids=430819&insurance_sector=public&practice_ids=168699&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=247841&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=66" | jq . > paris06.centre-de-vaccination-covid-19-mairie-du-6eme-arrondissement-de-paris.2594946.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2544453&agenda_ids=409357&insurance_sector=public&practice_ids=124877&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=188567&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=1540" | jq . > paris05.centre-covid19-paris-5.2544453.json
        # </PARIS>
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2544574&agenda_ids=424630&insurance_sector=public&practice_ids=163891&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=242174&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=26&vaccinationCenter=true&nbConfirmedVaccinationAppointments=628" | jq . > argenteuil-pfizer.centre-de-vaccination-covid-ch-victor-dupouy-d-argenteuil.2544574.json
        #curl "https://partners.doctolib.fr/availabilities.json?start_date=${start_date}&visit_motive_ids=2613873&agenda_ids=412945&insurance_sector=public&practice_ids=163891&destroy_temporary=true&limit=7&allowNewPatients=true&telehealth=false&profileId=242174&isOrganization=true&telehealthFeatureEnabled=false&vaccinationMotive=true&vaccinationDaysRange=28&vaccinationCenter=true&nbConfirmedVaccinationAppointments=628" | jq . > argenteuil-moderna.centre-de-vaccination-covid-ch-victor-dupouy-d-argenteuil.2613873.json
        sed -i -r 's/\"number_future_vaccinations\"\:\s*[0-9]+/\"number_future_vaccinations\"\:\"ignored\"/' *.json
    - name: Commit and push if it changed
      run: |-
        git config user.name "Automated"
        git config user.email "actions@users.noreply.github.com"
        git add -A
        timestamp=$(date -u)
        git commit -m "Latest data: ${timestamp}" || exit 0
        git push
